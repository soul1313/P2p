<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P · CALCULATIO MORTIS</title>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;900&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --ink:    #0a0805;
            --vellum: #0d0b08;
            --ash:    #111009;
            --bone:   #e8e0d0;
            --ivory:  #f2ede3;
            --silver: #b8b0a0;
            --ghost:  rgba(232,224,208,0.06);
            --dim:    rgba(232,224,208,0.35);
            --glow:   rgba(232,224,208,0.08);
            --red-ink:#8b1a1a;
            --gold:   #c8a96e;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        html { scroll-behavior:smooth; }

        body {
            font-family: 'IM Fell English', serif;
            background: var(--ink);
            color: var(--bone);
            min-height: 100vh;
            overflow-x: hidden;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='28' viewBox='0 0 20 28'%3E%3Cpath d='M10 0 L10 28 M0 14 L20 14' stroke='%23b8b0a0' stroke-width='1' opacity='0.7'/%3E%3Ccircle cx='10' cy='14' r='3' fill='none' stroke='%23b8b0a0' stroke-width='0.8' opacity='0.7'/%3E%3C/svg%3E") 10 14, crosshair;
        }

        /* ─── VIDEO BG ─── */
        #bg-video {
            position: fixed;
            inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: -4;
            opacity: 0.04;
            filter: grayscale(1) contrast(1.5);
        }

        /* ─── PAPER TEXTURE OVERLAY ─── */
        .paper-grain {
            position: fixed;
            inset: 0;
            z-index: -3;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
        }

        /* ─── VIGNETTE ─── */
        .vignette {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: radial-gradient(ellipse 80% 80% at 50% 50%, transparent 40%, rgba(0,0,0,0.85) 100%);
            pointer-events: none;
        }

        /* ─── CORNER ORNAMENTS ─── */
        .corner-ornaments {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
        }

        .corner {
            position: absolute;
            width: 120px; height: 120px;
            opacity: 0.18;
        }

        .corner svg { width: 100%; height: 100%; }
        .corner.tl { top: 0; left: 0; }
        .corner.tr { top: 0; right: 0; transform: scaleX(-1); }
        .corner.bl { bottom: 0; left: 0; transform: scaleY(-1); }
        .corner.br { bottom: 0; right: 0; transform: scale(-1); }

        /* ─── FLOATING PARTICLES ─── */
        .particles { position:fixed; inset:0; pointer-events:none; z-index:0; }
        .ash-particle {
            position: absolute;
            width: 2px; height: 2px;
            background: var(--bone);
            border-radius: 50%;
            animation: ashFall linear infinite;
            opacity: 0;
        }

        @keyframes ashFall {
            0%   { transform: translateY(-10px) translateX(0) rotate(0deg); opacity:0; }
            10%  { opacity: 0.4; }
            90%  { opacity: 0.15; }
            100% { transform: translateY(110vh) translateX(40px) rotate(360deg); opacity:0; }
        }

        /* ─── CURSOR GLOW ─── */
        .cursor-follow {
            position: fixed;
            width: 200px; height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(232,224,208,0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 999;
            transform: translate(-50%,-50%);
            transition: opacity 0.3s;
        }

        /* ─── SCANLINES ─── */
        .scanlines {
            position: fixed;
            inset: 0;
            z-index: 998;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg, transparent, transparent 3px,
                rgba(0,0,0,0.03) 3px, rgba(0,0,0,0.03) 4px
            );
        }

        /* ─── CONTAINER ─── */
        .container {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 28px 100px;
            position: relative;
            z-index: 2;
        }

        /* ─── HERO ─── */
        .hero {
            text-align: center;
            padding: 80px 20px 60px;
            position: relative;
        }

        .hero::before {
            content: '✦ ✦ ✦';
            display: block;
            font-size: 13px;
            letter-spacing: 12px;
            color: var(--dim);
            margin-bottom: 28px;
            animation: fadeIn 2s ease;
        }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        .hero-eyebrow {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 6px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 20px;
            animation: fadeIn 1.5s ease 0.3s both;
        }

        .hero-title {
            font-family: 'UnifrakturMaguntia', cursive;
            font-size: clamp(52px, 9vw, 120px);
            line-height: 0.85;
            color: var(--bone);
            letter-spacing: -2px;
            margin-bottom: 16px;
            animation: inkReveal 1.5s ease 0.5s both;
            text-shadow:
                0 0 80px rgba(232,224,208,0.07),
                0 2px 4px rgba(0,0,0,0.8);
        }

        @keyframes inkReveal {
            from { opacity:0; filter:blur(8px); transform:translateY(10px); }
            to   { opacity:1; filter:blur(0); transform:translateY(0); }
        }

        .hero-subtitle {
            font-family: 'Cinzel', serif;
            font-size: clamp(11px, 2vw, 15px);
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 40px;
            animation: fadeIn 1.5s ease 0.8s both;
        }

        /* Decorative rule */
        .ornament-line {
            display: flex;
            align-items: center;
            gap: 16px;
            justify-content: center;
            margin: 0 auto 48px;
            max-width: 600px;
            animation: fadeIn 1.5s ease 1s both;
        }

        .ornament-line::before,
        .ornament-line::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--dim));
        }

        .ornament-line::after {
            background: linear-gradient(270deg, transparent, var(--dim));
        }

        .ornament-symbol {
            font-size: 18px;
            color: var(--dim);
            letter-spacing: 6px;
        }

        /* Live counters row */
        .vitals {
            display: flex;
            justify-content: center;
            gap: 0;
            animation: fadeIn 1.5s ease 1.2s both;
        }

        .vital {
            padding: 0 40px;
            text-align: center;
            position: relative;
        }

        .vital + .vital::before {
            content: '';
            position: absolute;
            left: 0; top: 20%; bottom: 20%;
            width: 1px;
            background: var(--ghost);
        }

        .vital-num {
            font-family: 'Cinzel Decorative', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--bone);
            display: block;
            line-height: 1;
        }

        .vital-label {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-top: 6px;
            display: block;
        }

        /* ─── TICKER ─── */
        .ticker-wrap {
            border-top: 1px solid rgba(232,224,208,0.08);
            border-bottom: 1px solid rgba(232,224,208,0.08);
            padding: 10px 0;
            overflow: hidden;
            margin-bottom: 40px;
            position: relative;
        }

        .ticker-wrap::before, .ticker-wrap::after {
            content: '';
            position: absolute;
            top:0; bottom:0; width:120px;
            z-index:2;
        }

        .ticker-wrap::before { left:0; background:linear-gradient(90deg,var(--ink),transparent); }
        .ticker-wrap::after  { right:0; background:linear-gradient(270deg,var(--ink),transparent); }

        .ticker {
            display: flex;
            white-space: nowrap;
            animation: tickerScroll 50s linear infinite;
        }

        .ticker:hover { animation-play-state: paused; }

        @keyframes tickerScroll {
            from { transform: translateX(0); }
            to   { transform: translateX(-50%); }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0 36px;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dim);
        }

        .ticker-item em { color: var(--silver); font-style: normal; }
        .ticker-sep { color: rgba(232,224,208,0.2); font-size: 14px; }

        /* ─── GRID ─── */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ─── CARD ─── */
        .card {
            background: rgba(13,11,8,0.8);
            border: 1px solid rgba(232,224,208,0.1);
            border-radius: 2px;
            padding: 36px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            animation: cardReveal 0.8s cubic-bezier(0.16,1,0.3,1) both;
            transition: border-color 0.4s;
        }

        @keyframes cardReveal {
            from { opacity:0; transform:translateY(24px); }
            to   { opacity:1; transform:translateY(0); }
        }

        .card:hover {
            border-color: rgba(232,224,208,0.2);
        }

        /* Inner corner marks */
        .card::before, .card::after {
            content: '';
            position: absolute;
            width: 12px; height: 12px;
            pointer-events: none;
        }

        .card::before {
            top: -1px; left: -1px;
            border-top: 2px solid var(--silver);
            border-left: 2px solid var(--silver);
            opacity: 0.4;
        }

        .card::after {
            bottom: -1px; right: -1px;
            border-bottom: 2px solid var(--silver);
            border-right: 2px solid var(--silver);
            opacity: 0.4;
        }

        /* Top decoration line */
        .card-inner-top {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(232,224,208,0.12), transparent);
        }

        /* ─── SECTION TITLE ─── */
        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 22px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .section-title::before,
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(232,224,208,0.1);
        }

        .section { margin-bottom: 30px; }
        .section:last-child { margin-bottom: 0; }

        /* ─── INPUTS ─── */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .input-group { position: relative; }

        label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 8px;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            background: rgba(232,224,208,0.03);
            border: none;
            border-bottom: 1px solid rgba(232,224,208,0.15);
            border-radius: 0;
            padding: 12px 4px;
            color: var(--bone);
            font-family: 'Cinzel Decorative', serif;
            font-size: 16px;
            font-weight: 400;
            outline: none;
            transition: border-color 0.3s, background 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            border-bottom-color: var(--silver);
            background: rgba(232,224,208,0.04);
        }

        input::placeholder {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            color: rgba(232,224,208,0.18);
            font-size: 14px;
        }

        /* ─── CHECKBOX ─── */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px 16px;
            border: 1px solid rgba(232,224,208,0.1);
            border-radius: 0;
            transition: all 0.3s;
            user-select: none;
        }

        .checkbox-group:hover {
            border-color: rgba(232,224,208,0.25);
            background: rgba(232,224,208,0.02);
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px; height: 16px;
            margin: 0;
            accent-color: var(--silver);
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 11px;
            letter-spacing: 2px;
            cursor: pointer;
            color: var(--bone);
        }

        .commission-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 14px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .commission-inputs.active { max-height: 120px; }

        /* ─── RESULT CARD ─── */
        .result-card {
            margin-top: 24px;
            padding: 28px;
            border: 1px solid rgba(232,224,208,0.2);
            position: relative;
            animation: inkSpread 0.6s ease;
            background: rgba(232,224,208,0.02);
        }

        @keyframes inkSpread {
            from { opacity:0; clip-path: inset(0 100% 0 0); }
            to   { opacity:1; clip-path: inset(0 0% 0 0); }
        }

        .result-card.negative {
            border-color: rgba(139,26,26,0.4);
        }

        /* Decorative top border */
        .result-card::before {
            content: '';
            position: absolute;
            top: -1px; left: 20px; right: 20px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--silver), transparent);
            opacity: 0.3;
        }

        .result-card.negative::before {
            background: linear-gradient(90deg, transparent, var(--red-ink), transparent);
            opacity: 0.6;
        }

        .result-sigil {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-sigil::before { content: '†'; color: var(--silver); }

        .result-sigil.neg::before { content: '✗'; color: var(--red-ink); }

        .result-value {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(38px, 6vw, 58px);
            font-weight: 700;
            color: var(--ivory);
            line-height: 1;
            margin-bottom: 6px;
            text-shadow: 0 0 60px rgba(232,224,208,0.15);
            animation: countReveal 0.5s ease;
        }

        @keyframes countReveal {
            from { opacity:0; transform:translateY(6px); }
            to   { opacity:1; transform:translateY(0); }
        }

        .result-value.negative {
            color: var(--red-ink);
            text-shadow: 0 0 30px rgba(139,26,26,0.3);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(232,224,208,0.08);
        }

        .detail-item { display:flex; flex-direction:column; gap:5px; }

        .detail-label {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
        }

        .detail-value {
            font-family: 'Cinzel Decorative', serif;
            font-size: 16px;
            color: var(--bone);
        }

        /* ─── BUTTONS ─── */
        .btn {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(232,224,208,0.25);
            border-radius: 0;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 4px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 18px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: rgba(232,224,208,0.06);
            transition: transform 0.4s ease;
        }

        .btn:hover::before { transform: translateX(0); }

        .btn-primary {
            background: rgba(232,224,208,0.06);
            color: var(--bone);
        }

        .btn-primary:hover {
            border-color: var(--silver);
            background: rgba(232,224,208,0.1);
        }

        .btn-secondary {
            background: transparent;
            color: var(--dim);
            width: auto;
            padding: 12px 20px;
            margin: 0;
        }

        .btn-secondary:hover {
            color: var(--bone);
            border-color: rgba(232,224,208,0.3);
        }

        /* ─── STATS ─── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 14px;
            margin-bottom: 28px;
        }

        .stat-card {
            border: 1px solid rgba(232,224,208,0.08);
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            background: rgba(232,224,208,0.02);
        }

        .stat-card:hover {
            border-color: rgba(232,224,208,0.2);
            background: rgba(232,224,208,0.04);
        }

        /* Roman numeral corner */
        .stat-card::after {
            content: attr(data-num);
            position: absolute;
            bottom: 8px; right: 10px;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            color: rgba(232,224,208,0.1);
            letter-spacing: 1px;
        }

        .stat-glyph {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .stat-label {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Cinzel Decorative', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--bone);
        }

        .stat-value.profit { color: var(--ivory); }
        .stat-value.loss   { color: var(--red-ink); }

        /* ─── GOAL ─── */
        .goal-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-end;
        }

        .goal-input-group input { flex:1; }

        .progress-track {
            width: 100%; height: 2px;
            background: rgba(232,224,208,0.08);
            position: relative;
            margin-top: 16px;
        }

        .progress-fill {
            height: 100%;
            background: var(--bone);
            transition: width 1s cubic-bezier(0.16,1,0.3,1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: 0; top: -3px;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--ivory);
            box-shadow: 0 0 10px var(--bone);
        }

        .progress-pct {
            font-family: 'Cinzel Decorative', serif;
            font-size: 11px;
            color: var(--dim);
            text-align: right;
            margin-top: 8px;
        }

        .goal-stats {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 10px;
            margin-top: 16px;
        }

        .goal-stat {
            border: 1px solid rgba(232,224,208,0.08);
            padding: 12px;
            text-align: center;
        }

        .goal-stat-label {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 6px;
        }

        .goal-stat-value {
            font-family: 'Cinzel Decorative', serif;
            font-size: 18px;
            color: var(--bone);
        }

        /* ─── CHART ─── */
        .chart-container {
            position: relative;
            height: 260px;
            margin-top: 20px;
        }

        /* ─── ACHIEVEMENTS ─── */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 10px;
        }

        .achievement {
            border: 1px solid rgba(232,224,208,0.08);
            padding: 16px 12px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            background: transparent;
        }

        .achievement.unlocked {
            border-color: rgba(232,224,208,0.2);
            background: rgba(232,224,208,0.03);
        }

        .achievement.unlocked:hover {
            transform: translateY(-3px);
            border-color: rgba(232,224,208,0.35);
        }

        .achievement.locked {
            opacity: 0.2;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 22px;
            margin-bottom: 8px;
            display: block;
            filter: grayscale(1);
        }

        .achievement-title {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 4px;
            color: var(--bone);
        }

        .achievement-desc {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 10px;
            color: var(--dim);
        }

        .achievement-badge {
            position: absolute;
            top: 6px; right: 6px;
            font-size: 10px;
            color: var(--silver);
        }

        /* ─── P2P CODEX ─── */
        .codex-section {
            margin-bottom: 20px;
        }

        .codex-title {
            font-family: 'UnifrakturMaguntia', cursive;
            font-size: clamp(36px, 5vw, 64px);
            color: var(--bone);
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 0 40px rgba(232,224,208,0.06);
        }

        .codex-subtitle {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            text-align: center;
            color: var(--dim);
            margin-bottom: 36px;
            font-size: 15px;
        }

        .codex-grid {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 16px;
        }

        .codex-card {
            border: 1px solid rgba(232,224,208,0.08);
            padding: 28px;
            position: relative;
            transition: all 0.4s;
            background: rgba(232,224,208,0.01);
            cursor: default;
        }

        .codex-card::before {
            content: attr(data-numeral);
            position: absolute;
            top: 12px; right: 14px;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            color: rgba(232,224,208,0.15);
            letter-spacing: 1px;
        }

        .codex-card:hover {
            border-color: rgba(232,224,208,0.2);
            background: rgba(232,224,208,0.03);
            transform: translateY(-4px);
        }

        .codex-card-glyph {
            font-size: 26px;
            margin-bottom: 14px;
            filter: grayscale(1);
            opacity: 0.7;
        }

        .codex-card-title {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--bone);
            margin-bottom: 10px;
        }

        .codex-card-text {
            font-family: 'IM Fell English', serif;
            font-size: 13px;
            color: var(--dim);
            line-height: 1.7;
            font-style: italic;
        }

        /* ─── HISTORY ─── */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .history-actions { display:flex; gap:8px; flex-wrap:wrap; }

        .btn-small {
            padding: 8px 16px;
            border: 1px solid rgba(232,224,208,0.12);
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            cursor: pointer;
            background: transparent;
            color: var(--dim);
            transition: all 0.2s;
        }

        .btn-small:hover { border-color: rgba(232,224,208,0.3); color:var(--bone); }
        .btn-small.danger:hover { border-color: var(--red-ink); color: var(--red-ink); }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 520px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .history-list::-webkit-scrollbar { width: 2px; }
        .history-list::-webkit-scrollbar-track { background: transparent; }
        .history-list::-webkit-scrollbar-thumb { background: rgba(232,224,208,0.12); }
        .history-list::-webkit-scrollbar-thumb:hover { background: var(--silver); }

        .history-item {
            border: 1px solid rgba(232,224,208,0.08);
            padding: 16px 20px;
            transition: all 0.3s;
            animation: slideIn 0.3s ease;
            background: rgba(232,224,208,0.01);
            position: relative;
        }

        @keyframes slideIn {
            from { opacity:0; transform:translateX(-12px); }
            to   { opacity:1; transform:translateX(0); }
        }

        .history-item:hover {
            border-color: rgba(232,224,208,0.2);
            background: rgba(232,224,208,0.03);
            transform: translateX(3px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-date {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--dim);
        }

        .history-delete {
            background: none;
            border: none;
            color: rgba(232,224,208,0.2);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            line-height: 1;
        }

        .history-delete:hover { color: var(--red-ink); }

        .history-details {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 10px;
        }

        .history-detail { display:flex; flex-direction:column; gap:3px; }

        .history-detail-label {
            font-family: 'Cinzel', serif;
            font-size: 7px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dim);
        }

        .history-detail-value {
            font-family: 'Cinzel Decorative', serif;
            font-size: 14px;
            color: var(--bone);
        }

        .history-profit { color: var(--ivory); }
        .history-loss   { color: var(--red-ink); }

        /* ─── EMPTY STATE ─── */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--dim);
        }

        .empty-state-icon {
            font-family: 'UnifrakturMaguntia', cursive;
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
            display: block;
        }

        .empty-state-text {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 15px;
            line-height: 1.8;
        }

        /* ─── NOTIFICATION ─── */
        .notification {
            position: fixed;
            bottom: 32px; right: 32px;
            background: var(--vellum);
            border: 1px solid rgba(232,224,208,0.25);
            padding: 16px 24px;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--bone);
            z-index: 10000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
            backdrop-filter: blur(20px);
            max-width: 300px;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* ─── FOOTER ─── */
        .footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid rgba(232,224,208,0.06);
            color: var(--dim);
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .footer a { color: var(--silver); text-decoration: none; transition: color 0.2s; }
        .footer a:hover { color: var(--bone); }

        .footer-symbol {
            font-family: 'UnifrakturMaguntia', cursive;
            font-size: 28px;
            color: rgba(232,224,208,0.15);
            display: block;
            margin: 16px auto 12px;
        }

        /* ─── SHARE ─── */
        #shareContainer { position:fixed; left:-9999px; top:0; }

        /* ─── AUTH BUTTON (fixed top-right) ─── */
        .auth-btn {
            position: fixed;
            top: 24px; right: 24px;
            z-index: 9000;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            background: transparent;
            border: 1px solid rgba(232,224,208,0.15);
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .auth-btn:hover {
            color: var(--bone);
            border-color: rgba(232,224,208,0.4);
            background: rgba(232,224,208,0.04);
        }

        /* ─── MODAL BACKDROP ─── */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-fog {
            position: absolute;
            inset: 0;
            background: rgba(4,3,2,0.88);
            backdrop-filter: blur(8px);
        }

        /* ─── MODAL WINDOW ─── */
        .modal {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 480px;
            background: #0d0b08;
            border: 1px solid rgba(232,224,208,0.18);
            padding: 52px 48px 44px;
            transform: translateY(30px) scale(0.97);
            transition: transform 0.5s cubic-bezier(0.16,1,0.3,1), opacity 0.5s ease;
            opacity: 0;
        }

        .modal-backdrop.open .modal {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Inner corner marks on modal */
        .modal::before, .modal::after {
            content: '';
            position: absolute;
            width: 14px; height: 14px;
            pointer-events: none;
        }

        .modal::before {
            top: -1px; left: -1px;
            border-top: 2px solid var(--silver);
            border-left: 2px solid var(--silver);
            opacity: 0.5;
        }

        .modal::after {
            bottom: -1px; right: -1px;
            border-bottom: 2px solid var(--silver);
            border-right: 2px solid var(--silver);
            opacity: 0.5;
        }

        /* extra corners */
        .modal-corner-tr, .modal-corner-bl {
            position: absolute;
            width: 14px; height: 14px;
            pointer-events: none;
            opacity: 0.5;
        }

        .modal-corner-tr {
            top: -1px; right: -1px;
            border-top: 2px solid var(--silver);
            border-right: 2px solid var(--silver);
        }

        .modal-corner-bl {
            bottom: -1px; left: -1px;
            border-bottom: 2px solid var(--silver);
            border-left: 2px solid var(--silver);
        }

        /* Top ornament line */
        .modal-top-line {
            position: absolute;
            top: 0; left: 40px; right: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(232,224,208,0.25), transparent);
        }

        .modal-close {
            position: absolute;
            top: 16px; right: 16px;
            background: none;
            border: none;
            color: var(--dim);
            font-size: 18px;
            cursor: pointer;
            width: 28px; height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            font-family: 'Cinzel', serif;
        }

        .modal-close:hover { color: var(--bone); }

        /* ─── MODAL HEADER ─── */
        .modal-sigil {
            text-align: center;
            margin-bottom: 6px;
        }

        .modal-sigil-text {
            font-family: 'UnifrakturMaguntia', cursive;
            font-size: 48px;
            color: var(--bone);
            line-height: 1;
            text-shadow: 0 0 40px rgba(232,224,208,0.08);
        }

        .modal-eyebrow {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--dim);
            text-align: center;
            margin-bottom: 6px;
        }

        .modal-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--ivory);
            text-align: center;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 13px;
            color: var(--dim);
            text-align: center;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .modal-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 0 28px;
        }

        .modal-divider::before,
        .modal-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(232,224,208,0.1);
        }

        .modal-divider span {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            color: var(--dim);
            letter-spacing: 2px;
        }

        /* ─── MODAL FIELDS ─── */
        .modal-field {
            margin-bottom: 20px;
            position: relative;
        }

        .modal-field label {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-field label::before {
            content: '†';
            color: rgba(232,224,208,0.2);
            font-size: 10px;
        }

        .modal-field input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(232,224,208,0.15);
            padding: 12px 0;
            color: var(--bone);
            font-family: 'Cinzel Decorative', serif;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
            letter-spacing: 1px;
        }

        .modal-field input:focus {
            border-bottom-color: var(--silver);
        }

        .modal-field input::placeholder {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 13px;
            color: rgba(232,224,208,0.18);
            letter-spacing: 0;
        }

        /* Ink underline animation */
        .modal-field::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 0; height: 1px;
            background: var(--silver);
            transition: width 0.4s ease;
        }

        .modal-field:focus-within::after { width: 100%; }

        /* ─── STRENGTH BAR ─── */
        .strength-wrap {
            margin-top: 10px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .strength-bar {
            flex: 1;
            height: 2px;
            background: rgba(232,224,208,0.08);
            position: relative;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            background: var(--bone);
            transition: width 0.3s ease, background 0.3s ease;
        }

        .strength-label {
            font-family: 'Cinzel', serif;
            font-size: 7px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dim);
            white-space: nowrap;
            min-width: 60px;
            text-align: right;
        }

        /* ─── MODAL CHECKBOX ─── */
        .modal-check {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 24px;
            cursor: pointer;
        }

        .modal-check input[type="checkbox"] {
            width: 14px; height: 14px;
            margin-top: 2px;
            accent-color: var(--silver);
            cursor: pointer;
            flex-shrink: 0;
        }

        .modal-check span {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 12px;
            color: var(--dim);
            line-height: 1.5;
        }

        /* ─── MODAL BUTTON ─── */
        .modal-submit {
            width: 100%;
            padding: 16px;
            background: rgba(232,224,208,0.06);
            border: 1px solid rgba(232,224,208,0.2);
            color: var(--bone);
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 4px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .modal-submit::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(232,224,208,0.04);
            transform: translateX(-100%);
            transition: transform 0.4s ease;
        }

        .modal-submit:hover { border-color: rgba(232,224,208,0.4); }
        .modal-submit:hover::before { transform: translateX(0); }

        /* ─── MODAL SWITCH ─── */
        .modal-switch {
            text-align: center;
        }

        .modal-switch-text {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 12px;
            color: var(--dim);
        }

        .modal-switch-link {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 1px;
            color: var(--silver);
            cursor: pointer;
            background: none;
            border: none;
            text-decoration: none;
            transition: color 0.2s;
            margin-left: 4px;
        }

        .modal-switch-link:hover { color: var(--bone); }

        /* ─── MODAL TABS ─── */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(232,224,208,0.1);
            margin-bottom: 28px;
            gap: 0;
        }

        .modal-tab {
            flex: 1;
            padding: 10px;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dim);
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.3s;
        }

        .modal-tab.active {
            color: var(--bone);
            border-bottom-color: var(--silver);
        }

        .modal-tab:hover { color: var(--bone); }

        /* Forms visibility */
        .modal-form { display: none; }
        .modal-form.active { display: block; animation: formFade 0.4s ease; }

        @keyframes formFade {
            from { opacity:0; transform: translateY(8px); }
            to   { opacity:1; transform: translateY(0); }
        }

        /* ─── LOGGED IN STATE ─── */
        .user-badge {
            position: fixed;
            top: 24px; right: 24px;
            z-index: 9000;
            display: none;
            align-items: center;
            gap: 10px;
            background: rgba(13,11,8,0.9);
            border: 1px solid rgba(232,224,208,0.15);
            padding: 8px 14px;
            backdrop-filter: blur(10px);
        }

        .user-badge.visible { display: flex; }

        .user-badge-name {
            font-family: 'Cinzel', 'Georgia', serif;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--bone);
        }

        .user-badge-role {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 10px;
            color: var(--dim);
        }

        .user-badge-sep { color: rgba(232,224,208,0.2); }

        .user-logout {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 1px;
            color: var(--dim);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            text-transform: uppercase;
        }

        .user-logout:hover { color: var(--red-ink); }

        /* Seals / error messages */
        .field-error {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 11px;
            color: var(--red-ink);
            margin-top: 5px;
            display: none;
        }

        .field-error.show { display: block; animation: formFade 0.3s ease; }

        /* ─── PLAN BADGE ON USER BADGE ─── */
        .plan-tag {
            font-family: 'Cinzel', serif;
            font-size: 7px;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 2px 7px;
            border: 1px solid rgba(232,224,208,0.2);
            color: var(--dim);
        }

        .plan-tag.premium {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ─── SYNC INDICATOR on history header ─── */
        .sync-note {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 12px;
            color: var(--dim);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: rgba(232,224,208,0.2);
            flex-shrink: 0;
        }

        .sync-dot.active {
            background: var(--gold);
            box-shadow: 0 0 6px rgba(200,169,110,0.6);
            animation: syncPulse 2s ease-in-out infinite;
        }

        @keyframes syncPulse {
            0%,100% { opacity:1; }
            50%      { opacity:0.4; }
        }

        /* ─── PAYWALL MODAL ─── */
        .paywall-backdrop {
            position: fixed;
            inset: 0;
            z-index: 11000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .paywall-backdrop.open {
            opacity: 1;
            pointer-events: all;
        }

        .paywall-fog {
            position: absolute;
            inset: 0;
            background: rgba(2,1,1,0.92);
            backdrop-filter: blur(10px);
        }

        .paywall {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 520px;
            background: #0d0b08;
            border: 1px solid rgba(200,169,110,0.25);
            padding: 52px 48px 44px;
            transform: translateY(24px) scale(0.97);
            transition: transform 0.5s cubic-bezier(0.16,1,0.3,1), opacity 0.5s;
            opacity: 0;
        }

        .paywall-backdrop.open .paywall {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .paywall::before { content:''; position:absolute; top:-1px; left:40px; right:40px; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); opacity:0.4; }
        .paywall::after  { content:''; position:absolute; bottom:-1px; left:40px; right:40px; height:1px; background:linear-gradient(90deg,transparent,rgba(200,169,110,0.3),transparent); }

        .paywall-corner { position:absolute; width:14px; height:14px; opacity:0.5; }
        .paywall-corner.tl { top:-1px; left:-1px; border-top:2px solid var(--gold); border-left:2px solid var(--gold); }
        .paywall-corner.tr { top:-1px; right:-1px; border-top:2px solid var(--gold); border-right:2px solid var(--gold); }
        .paywall-corner.bl { bottom:-1px; left:-1px; border-bottom:2px solid var(--gold); border-left:2px solid var(--gold); }
        .paywall-corner.br { bottom:-1px; right:-1px; border-bottom:2px solid var(--gold); border-right:2px solid var(--gold); }

        .paywall-close {
            position: absolute;
            top:16px; right:16px;
            background:none; border:none;
            color:var(--dim); font-size:18px; cursor:pointer;
            transition:color 0.2s; font-family:'Cinzel',serif;
            width:28px; height:28px;
            display:flex; align-items:center; justify-content:center;
        }
        .paywall-close:hover { color:var(--bone); }

        .paywall-crown {
            text-align: center;
            font-size: 40px;
            margin-bottom: 6px;
            filter: grayscale(0.3) sepia(0.5);
        }

        .paywall-eyebrow {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--gold);
            text-align: center;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .paywall-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--ivory);
            text-align: center;
            margin-bottom: 8px;
        }

        .paywall-sub {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 14px;
            color: var(--dim);
            text-align: center;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        /* ─── PLANS COMPARE ─── */
        .plans-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 28px;
        }

        .plan-card {
            border: 1px solid rgba(232,224,208,0.1);
            padding: 22px 18px;
            position: relative;
            transition: border-color 0.3s;
        }

        .plan-card.highlight {
            border-color: rgba(200,169,110,0.4);
            background: rgba(200,169,110,0.03);
        }

        .plan-card-label {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 8px;
        }

        .plan-card.highlight .plan-card-label { color: var(--gold); }

        .plan-price {
            font-family: 'Cinzel Decorative', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--bone);
            margin-bottom: 16px;
            line-height: 1;
        }

        .plan-price small {
            font-size: 12px;
            color: var(--dim);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
        }

        .plan-features {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-feature {
            font-family: 'IM Fell English', serif;
            font-size: 12px;
            color: var(--dim);
            display: flex;
            align-items: flex-start;
            gap: 8px;
            line-height: 1.4;
        }

        .plan-feature::before { content: '†'; color: rgba(232,224,208,0.2); flex-shrink:0; }
        .plan-feature.yes { color: var(--bone); }
        .plan-feature.yes::before { content: '✓'; color: var(--gold); }
        .plan-feature.no { text-decoration: line-through; opacity: 0.35; }
        .plan-feature.no::before { content: '✗'; color: var(--red-ink); opacity:0.6; }

        /* ─── PAYMENT FORM ─── */
        .payment-divider {
            display: flex; align-items: center; gap: 12px; margin-bottom: 22px;
        }
        .payment-divider::before,.payment-divider::after { content:''; flex:1; height:1px; background:rgba(232,224,208,0.08); }
        .payment-divider span { font-family:'Cinzel',serif; font-size:9px; color:var(--dim); letter-spacing:2px; }

        .payment-amount {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-amount-num {
            font-family: 'Cinzel Decorative', serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--gold);
        }

        .payment-amount-label {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 12px;
            color: var(--dim);
            margin-top: 2px;
        }

        .payment-field {
            margin-bottom: 16px;
            position: relative;
        }

        .payment-field label {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 8px;
            display: block;
        }

        .payment-field input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(232,224,208,0.15);
            padding: 10px 0;
            color: var(--bone);
            font-family: 'Cinzel Decorative', serif;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            letter-spacing: 2px;
        }

        .payment-field input:focus { border-bottom-color: var(--gold); }
        .payment-field input::placeholder {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 13px;
            color: rgba(232,224,208,0.15);
            letter-spacing: 0;
        }

        .payment-field::after {
            content:'';
            position:absolute;
            bottom:0; left:0;
            width:0; height:1px;
            background:var(--gold);
            transition:width 0.4s;
        }
        .payment-field:focus-within::after { width:100%; }

        .payment-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }

        .pay-btn {
            width: 100%;
            padding: 16px;
            background: rgba(200,169,110,0.08);
            border: 1px solid rgba(200,169,110,0.4);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 4px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            margin-bottom: 14px;
        }

        .pay-btn::before {
            content:'';
            position:absolute; inset:0;
            background:rgba(200,169,110,0.06);
            transform:translateX(-100%);
            transition:transform 0.4s;
        }

        .pay-btn:hover { background:rgba(200,169,110,0.12); border-color:rgba(200,169,110,0.7); }
        .pay-btn:hover::before { transform:translateX(0); }

        .pay-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pay-secure {
            text-align:center;
            font-family:'IM Fell English',serif;
            font-style:italic;
            font-size:11px;
            color:var(--dim);
        }

        /* Loading state */
        .pay-btn.loading { pointer-events:none; }
        .pay-btn.loading::after {
            content:'';
            display:inline-block;
            width:10px; height:10px;
            border:1px solid var(--gold);
            border-top-color:transparent;
            border-radius:50%;
            animation:spin 0.7s linear infinite;
            margin-left:10px;
            vertical-align:middle;
        }

        @keyframes spin { to { transform:rotate(360deg); } }

        /* Success state */
        .pay-success {
            text-align:center;
            padding:20px 0;
            animation:formFade 0.5s ease;
        }

        .pay-success-icon {
            font-size:40px;
            margin-bottom:12px;
        }

        .pay-success-title {
            font-family:'Cinzel Decorative',serif;
            font-size:18px;
            color:var(--gold);
            margin-bottom:8px;
        }

        .pay-success-text {
            font-family:'IM Fell English',serif;
            font-style:italic;
            font-size:13px;
            color:var(--dim);
            line-height:1.6;
        }

        /* paywall views */
        .pw-view { display:none; }
        .pw-view.active { display:block; animation:formFade 0.4s ease; }

        /* ─── LOCK OVERLAY on save button ─── */
        .save-lock-note {
            margin-top: 12px;
            padding: 12px 16px;
            border: 1px solid rgba(200,169,110,0.2);
            background: rgba(200,169,110,0.03);
            display: none;
        }

        .save-lock-note.visible { display: flex; align-items: center; gap: 10px; }

        .save-lock-note-text {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 12px;
            color: var(--dim);
            flex: 1;
            line-height: 1.5;
        }

        .save-lock-link {
            font-family: 'Cinzel', serif;
            font-size: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--gold);
            cursor: pointer;
            background: none;
            border: none;
            white-space: nowrap;
            transition: opacity 0.2s;
        }

        .save-lock-link:hover { opacity: 0.7; }

        /* ─── CUSTOM CONFIRM DIALOG ─── */
        .confirm-backdrop {
            position: fixed;
            inset: 0;
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(2,1,1,0.85);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .confirm-backdrop.open {
            opacity: 1;
            pointer-events: all;
        }

        .confirm-box {
            background: #0d0b08;
            border: 1px solid rgba(232,224,208,0.2);
            padding: 36px 40px 28px;
            max-width: 360px;
            width: 100%;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
        }

        .confirm-backdrop.open .confirm-box { transform: scale(1); }

        .confirm-box::before { content:''; position:absolute; top:-1px; left:-1px; width:12px; height:12px; border-top:2px solid var(--silver); border-left:2px solid var(--silver); opacity:0.5; }
        .confirm-box::after  { content:''; position:absolute; bottom:-1px; right:-1px; width:12px; height:12px; border-bottom:2px solid var(--silver); border-right:2px solid var(--silver); opacity:0.5; }

        .confirm-glyph {
            font-size: 28px;
            text-align: center;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        .confirm-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 14px;
            color: var(--bone);
            text-align: center;
            margin-bottom: 8px;
        }

        .confirm-text {
            font-family: 'IM Fell English', serif;
            font-style: italic;
            font-size: 13px;
            color: var(--dim);
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .confirm-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .confirm-btn {
            padding: 11px;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid rgba(232,224,208,0.15);
            background: transparent;
            color: var(--dim);
            transition: all 0.2s;
        }

        .confirm-btn:hover { color: var(--bone); border-color: rgba(232,224,208,0.35); }

        .confirm-btn.danger {
            border-color: rgba(139,26,26,0.4);
            color: rgba(200,80,80,0.8);
        }

        .confirm-btn.danger:hover {
            background: rgba(139,26,26,0.1);
            border-color: var(--red-ink);
            color: #cc4444;
        }

        /* ─── RESPONSIVE ─── */
        @media (max-width: 1100px) {
            .grid-2 { grid-template-columns: 1fr; }
            .codex-grid { grid-template-columns: repeat(2,1fr); }
        }

        @media (max-width: 680px) {
            .container {
                padding: 0 14px 80px;
            }

            .hero {
                padding: 60px 12px 40px;
            }

            .hero-title {
                font-size: clamp(48px, 13vw, 72px);
                letter-spacing: -1px;
            }

            .hero-subtitle {
                font-size: 13px;
                letter-spacing: 3px;
            }

            .hero-eyebrow {
                font-size: 10px;
                letter-spacing: 4px;
            }

            .vitals {
                gap: 0;
            }

            .vital {
                padding: 0 14px;
            }

            .vital-num {
                font-size: 22px;
            }

            .vital-label {
                font-size: 8px;
                letter-spacing: 1.5px;
            }

            .input-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .achievements-grid { grid-template-columns: repeat(2,1fr); }
            .goal-stats { grid-template-columns: 1fr 1fr; }
            .codex-grid { grid-template-columns: 1fr; }

            .card {
                padding: 22px 18px;
                border-radius: 0;
            }

            .result-value {
                font-size: clamp(32px, 9vw, 48px);
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-card {
                padding: 16px 14px;
            }

            .section-title {
                font-size: 9px;
                letter-spacing: 2px;
            }

            label {
                font-size: 8px;
                letter-spacing: 2px;
            }

            input[type="number"],
            input[type="text"] {
                font-size: 15px;
                padding: 10px 4px;
            }

            .btn {
                padding: 14px;
                font-size: 9px;
                letter-spacing: 2px;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .history-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .btn-small {
                padding: 7px 12px;
                font-size: 7px;
                letter-spacing: 1.5px;
            }

            .codex-card {
                padding: 20px 16px;
            }

            .codex-title {
                font-size: clamp(30px, 9vw, 48px);
            }

            .ticker-item {
                font-size: 9px;
                letter-spacing: 1px;
                padding: 0 20px;
            }

            .auth-btn {
                font-size: 8px;
                letter-spacing: 2px;
                padding: 8px 12px;
                top: 14px;
                right: 14px;
            }

            .user-badge {
                top: 14px;
                right: 14px;
                padding: 6px 10px;
                gap: 7px;
            }

            .user-badge-name {
                font-size: 9px;
            }

            .user-badge-role {
                font-size: 8px;
            }

            .corner {
                width: 70px;
                height: 70px;
            }

            .hero::before {
                font-size: 10px;
                letter-spacing: 8px;
                margin-bottom: 18px;
            }

            .plans-row {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 36px 24px 28px;
            }

            .paywall {
                padding: 36px 24px 28px;
            }

            .modal-title {
                font-size: 16px;
            }

            .paywall-title {
                font-size: 18px;
            }

            .history-details {
                grid-template-columns: 1fr 1fr;
            }

            .result-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 400px) {
            .vital { padding: 0 10px; }
            .vital-num { font-size: 18px; }
            .hero-title { font-size: 42px; }
            .stats-grid { grid-template-columns: 1fr; }
            .goal-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <!-- VIDEO BG -->
    <video id="bg-video" autoplay muted loop playsinline>
        <source src="https://assets.mixkit.co/videos/preview/mixkit-digital-money-transfer-network-30010-large.mp4" type="video/mp4">
    </video>

    <div class="paper-grain"></div>
    <div class="vignette"></div>
    <div class="scanlines"></div>

    <!-- CORNER ORNAMENTS -->
    <div class="corner-ornaments">
        <div class="corner tl">
            <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 10 L10 60 M10 10 L60 10" stroke="#b8b0a0" stroke-width="1"/>
                <path d="M20 20 L20 50 M20 20 L50 20" stroke="#b8b0a0" stroke-width="0.5"/>
                <circle cx="10" cy="10" r="3" fill="none" stroke="#b8b0a0" stroke-width="0.8"/>
                <path d="M30 10 Q40 20 30 30 Q20 40 30 50" stroke="#b8b0a0" stroke-width="0.6" fill="none"/>
                <path d="M10 30 Q20 40 30 30 Q40 20 50 30" stroke="#b8b0a0" stroke-width="0.6" fill="none"/>
                <circle cx="20" cy="20" r="1.5" fill="#b8b0a0"/>
                <circle cx="10" cy="60" r="2" fill="none" stroke="#b8b0a0" stroke-width="0.6"/>
                <circle cx="60" cy="10" r="2" fill="none" stroke="#b8b0a0" stroke-width="0.6"/>
            </svg>
        </div>
        <div class="corner tr">
            <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 10 L10 60 M10 10 L60 10" stroke="#b8b0a0" stroke-width="1"/>
                <path d="M20 20 L20 50 M20 20 L50 20" stroke="#b8b0a0" stroke-width="0.5"/>
                <circle cx="10" cy="10" r="3" fill="none" stroke="#b8b0a0" stroke-width="0.8"/>
                <path d="M30 10 Q40 20 30 30 Q20 40 30 50" stroke="#b8b0a0" stroke-width="0.6" fill="none"/>
                <path d="M10 30 Q20 40 30 30 Q40 20 50 30" stroke="#b8b0a0" stroke-width="0.6" fill="none"/>
                <circle cx="20" cy="20" r="1.5" fill="#b8b0a0"/>
            </svg>
        </div>
        <div class="corner bl">
            <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 10 L10 60 M10 10 L60 10" stroke="#b8b0a0" stroke-width="1"/>
                <path d="M20 20 L20 50 M20 20 L50 20" stroke="#b8b0a0" stroke-width="0.5"/>
                <circle cx="10" cy="10" r="3" fill="none" stroke="#b8b0a0" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="1.5" fill="#b8b0a0"/>
            </svg>
        </div>
        <div class="corner br">
            <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 10 L10 60 M10 10 L60 10" stroke="#b8b0a0" stroke-width="1"/>
                <path d="M20 20 L20 50 M20 20 L50 20" stroke="#b8b0a0" stroke-width="0.5"/>
                <circle cx="10" cy="10" r="3" fill="none" stroke="#b8b0a0" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="1.5" fill="#b8b0a0"/>
            </svg>
        </div>
    </div>

    <!-- PARTICLES -->
    <div class="particles" id="particles"></div>

    <!-- CURSOR GLOW -->
    <div class="cursor-follow" id="cursor"></div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>

    <!-- SHARE -->
    <div id="shareContainer"></div>

    <!-- AUTH BUTTON -->
    <button class="auth-btn" id="authBtn" onclick="openModal()">† Войти в Орден</button>

    <!-- USER BADGE (logged in) -->
    <div class="user-badge" id="userBadge">
        <div>
            <div class="user-badge-name" id="badgeName">—</div>
            <div class="user-badge-role" id="badgeRole">Арбитражник</div>
        </div>
        <span class="plan-tag" id="planTag">Free</span>
        <button class="save-lock-link" id="upgradeBtn" onclick="openPaywall()" style="display:none">† Upgrade</button>
        <span class="user-badge-sep">|</span>
        <button class="user-logout" onclick="logout()">Выйти</button>
    </div>

    <!-- REGISTRATION MODAL -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="handleBackdropClick(event)">
        <div class="modal-fog"></div>
        <div class="modal" id="modal">
            <div class="modal-top-line"></div>
            <div class="modal-corner-tr"></div>
            <div class="modal-corner-bl"></div>
            <button class="modal-close" onclick="closeModal()">✕</button>

            <!-- Header -->
            <div class="modal-sigil">
                <div class="modal-sigil-text">𝔓</div>
            </div>
            <div class="modal-eyebrow">P2P Calculatio · Ordo Arbitri</div>
            <div class="modal-title" id="modalTitle">Вступить в Орден</div>
            <div class="modal-subtitle" id="modalSubtitle">
                Запишите своё имя в анналы P2P.<br>
                <em>Omnia Vincit Pecunia.</em>
            </div>

            <!-- Tabs -->
            <div class="modal-tabs">
                <button class="modal-tab active" id="tabReg" onclick="switchTab('reg')">† Регистрация</button>
                <button class="modal-tab" id="tabLogin" onclick="switchTab('login')">† Вход</button>
            </div>

            <!-- REGISTER FORM -->
            <div class="modal-form active" id="formReg">
                <div class="modal-field">
                    <label for="regName">Имя арбитражника</label>
                    <input type="text" id="regName" placeholder="Как вас нарекли…" autocomplete="off">
                    <div class="field-error" id="errRegName">Имя не может быть пустым</div>
                </div>

                <div class="modal-field">
                    <label for="regEmail">Адрес epistula</label>
                    <input type="email" id="regEmail" placeholder="your@email.com" autocomplete="off">
                    <div class="field-error" id="errRegEmail">Введите корректный адрес</div>
                </div>

                <div class="modal-field">
                    <label for="regPass">Пароль-заклинание</label>
                    <input type="password" id="regPass" placeholder="Не менее 6 знаков…" oninput="checkStrength(this.value)">
                    <div class="strength-wrap">
                        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                        <div class="strength-label" id="strengthLabel">—</div>
                    </div>
                    <div class="field-error" id="errRegPass">Минимум 6 символов</div>
                </div>

                <div class="modal-field">
                    <label for="regPass2">Повторите пароль</label>
                    <input type="password" id="regPass2" placeholder="Ещё раз…">
                    <div class="field-error" id="errRegPass2">Пароли не совпадают</div>
                </div>

                <label class="modal-check">
                    <input type="checkbox" id="regAgree">
                    <span>Я принимаю <em>Кодекс Арбитражника</em> и согласен с тем, что все данные хранятся только в моём браузере</span>
                </label>
                <div class="field-error" id="errRegAgree" style="margin-top:-18px;margin-bottom:18px;">Необходимо принять Кодекс</div>

                <button class="modal-submit" onclick="submitRegister()">† Записать в анналы</button>

                <div class="modal-switch">
                    <span class="modal-switch-text">Уже в ордене?</span>
                    <button class="modal-switch-link" onclick="switchTab('login')">Войти</button>
                </div>
            </div>

            <!-- LOGIN FORM -->
            <div class="modal-form" id="formLogin">
                <div class="modal-field">
                    <label for="loginEmail">Адрес epistula</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="off">
                    <div class="field-error" id="errLoginEmail">Введите адрес</div>
                </div>

                <div class="modal-field">
                    <label for="loginPass">Пароль-заклинание</label>
                    <input type="password" id="loginPass" placeholder="Ваш пароль…">
                    <div class="field-error" id="errLoginPass">Введите пароль</div>
                </div>

                <div class="field-error" id="errLogin" style="margin-bottom:16px;font-size:13px;"></div>

                <button class="modal-submit" onclick="submitLogin()">† Открыть врата</button>

                <div class="modal-switch">
                    <span class="modal-switch-text">Ещё не в ордене?</span>
                    <button class="modal-switch-link" onclick="switchTab('reg')">Вступить</button>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- ══════════════════════════════════════════
         PAYWALL MODAL
    ══════════════════════════════════════════ -->
    <div class="paywall-backdrop" id="paywallBackdrop" onclick="handlePaywallBackdrop(event)">
        <div class="paywall-fog"></div>
        <div class="paywall" id="paywallModal">
            <div class="paywall-corner tl"></div>
            <div class="paywall-corner tr"></div>
            <div class="paywall-corner bl"></div>
            <div class="paywall-corner br"></div>
            <button class="paywall-close" onclick="closePaywall()">✕</button>

            <!-- VIEW 1: Plans comparison -->
            <div class="pw-view active" id="pwPlans">
                <div class="paywall-crown">👑</div>
                <div class="paywall-eyebrow">Ordo Premium · Синхронизация</div>
                <div class="paywall-title">Облачный Архив</div>
                <div class="paywall-sub">
                    Ваши сделки следуют за вами.<br>
                    <em>Любое устройство — один архив.</em>
                </div>

                <div class="plans-row">
                    <!-- Free -->
                    <div class="plan-card">
                        <div class="plan-card-label">Послушник</div>
                        <div class="plan-price">0 ₽ <small>/ всегда</small></div>
                        <ul class="plan-features">
                            <li class="plan-feature yes">Калькулятор прибыли</li>
                            <li class="plan-feature yes">Достижения и цели</li>
                            <li class="plan-feature yes">Экспорт CSV</li>
                            <li class="plan-feature yes">Локальное хранение</li>
                            <li class="plan-feature no">Облачная синхронизация</li>
                            <li class="plan-feature no">Данные на всех устройствах</li>
                        </ul>
                    </div>
                    <!-- Premium -->
                    <div class="plan-card highlight">
                        <div class="plan-card-label">Рыцарь Ордена</div>
                        <div class="plan-price">99 ₽ <small>/ раз</small></div>
                        <ul class="plan-features">
                            <li class="plan-feature yes">Калькулятор прибыли</li>
                            <li class="plan-feature yes">Достижения и цели</li>
                            <li class="plan-feature yes">Экспорт CSV</li>
                            <li class="plan-feature yes">Локальное хранение</li>
                            <li class="plan-feature yes">Облачная синхронизация</li>
                            <li class="plan-feature yes">Данные на всех устройствах</li>
                        </ul>
                    </div>
                </div>

                <button class="pay-btn" onclick="pwGoPayment()">† Вступить за 99 ₽</button>
                <div class="pay-secure">
                    Единовременный платёж · Без подписки · Навсегда
                </div>
            </div>

            <!-- VIEW 2: Payment form -->
            <div class="pw-view" id="pwPayment">
                <div class="paywall-eyebrow">Инициация · Оплата</div>
                <div class="paywall-title">Внести дань</div>
                <div class="payment-amount">
                    <div class="payment-amount-num">99 ₽</div>
                    <div class="payment-amount-label">единовременно · без подписки</div>
                </div>

                <div class="payment-divider"><span>реквизиты</span></div>

                <div class="payment-field">
                    <label>Номер карты</label>
                    <input type="text" id="payCard" placeholder="0000 0000 0000 0000" maxlength="19" oninput="formatCard(this)">
                </div>
                <div class="payment-row">
                    <div class="payment-field">
                        <label>Срок действия</label>
                        <input type="text" id="payExpiry" placeholder="ММ/ГГ" maxlength="5" oninput="formatExpiry(this)">
                    </div>
                    <div class="payment-field">
                        <label>CVV / CVC</label>
                        <input type="password" id="payCvv" placeholder="• • •" maxlength="3">
                    </div>
                </div>
                <div class="payment-field">
                    <label>Имя на карте</label>
                    <input type="text" id="payName" placeholder="Имя арбитражника…" style="text-transform:uppercase">
                </div>

                <div class="field-error" id="errPay" style="margin-bottom:14px;font-size:13px;"></div>

                <button class="pay-btn" id="paySubmitBtn" onclick="submitPayment()">† Оплатить 99 ₽</button>
                <div class="pay-secure">🔒 Демо-платёж · Данные карты не сохраняются</div>
                <br>
                <button class="modal-switch-link" onclick="pwBack()" style="margin-top:8px;display:block;text-align:center;color:var(--dim);">← Назад к планам</button>
            </div>

            <!-- VIEW 3: Success -->
            <div class="pw-view" id="pwSuccess">
                <div class="pay-success">
                    <div class="pay-success-icon">⚜</div>
                    <div class="pay-success-title">Посвящение принято</div>
                    <div class="pay-success-text">
                        Вы стали <em>Рыцарем Ордена</em>.<br>
                        Облачная синхронизация активирована.<br>
                        Ваши сделки теперь следуют за вами.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM CONFIRM DIALOG -->
    <div class="confirm-backdrop" id="confirmBackdrop">
        <div class="confirm-box">
            <div class="confirm-glyph">⚔</div>
            <div class="confirm-title" id="confirmTitle">Покинуть Орден?</div>
            <div class="confirm-text" id="confirmText">Локальные данные сохранятся.<br><em>Вы можете вернуться в любой момент.</em></div>
            <div class="confirm-btns">
                <button class="confirm-btn" onclick="confirmCancel()">† Остаться</button>
                <button class="confirm-btn danger" id="confirmOkBtn" onclick="confirmOk()">Выйти</button>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- ─── HERO ─── -->
        <div class="hero">
            <div class="hero-eyebrow">Anno Domini MMXXVI</div>
            <h1 class="hero-title">P2P Calculatio</h1>
            <p class="hero-subtitle">Mortis · Lucri · Veritatis</p>
            <div class="ornament-line">
                <span class="ornament-symbol">⸻ ✦ ⸻</span>
            </div>
            <div class="vitals">
                <div class="vital">
                    <span class="vital-num" id="h-trades">0</span>
                    <span class="vital-label">Сделок</span>
                </div>
                <div class="vital">
                    <span class="vital-num" id="h-profit">0 ₽</span>
                    <span class="vital-label">Прибыль</span>
                </div>
                <div class="vital">
                    <span class="vital-num" id="h-avg">0.0%</span>
                    <span class="vital-label">Доходность</span>
                </div>
            </div>
        </div>

        <!-- TICKER -->
        <div class="ticker-wrap">
            <div class="ticker" id="ticker">
                <div class="ticker-item">† <em>Спред</em> — источник прибыли P2P-трейдера</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>USDT/RUB</em> — наиболее ликвидная пара</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Оптимальный спред: <em>от 1% до 5%</em></div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>Эскроу</em> — щит P2P-арбитражника</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Комиссии <em>съедают</em> прибыль — считай точно</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>BTC · ETH · USDT</em> — трио вечности</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Данные хранятся <em>только у тебя</em></div>
                <span class="ticker-sep">·</span>
                <!-- duplicate -->
                <div class="ticker-item">† <em>Спред</em> — источник прибыли P2P-трейдера</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>USDT/RUB</em> — наиболее ликвидная пара</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Оптимальный спред: <em>от 1% до 5%</em></div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>Эскроу</em> — щит P2P-арбитражника</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Комиссии <em>съедают</em> прибыль — считай точно</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† <em>BTC · ETH · USDT</em> — трио вечности</div>
                <span class="ticker-sep">·</span>
                <div class="ticker-item">† Данные хранятся <em>только у тебя</em></div>
                <span class="ticker-sep">·</span>
            </div>
        </div>

        <!-- ─── CALC + STATS ─── -->
        <div class="grid-2">
            <div class="card" style="animation-delay:0.1s">
                <div class="card-inner-top"></div>

                <div class="section">
                    <div class="section-title">Параметры</div>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="amount">Сумма вложений ₽</label>
                            <input type="number" id="amount" placeholder="5 000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="buyRate">Курс покупки</label>
                            <input type="number" id="buyRate" placeholder="77.80" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="sellRate">Курс продажи</label>
                            <input type="number" id="sellRate" placeholder="87.20" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="currency">Криптовалюта</label>
                            <input type="text" id="currency" placeholder="USDT" value="USDT">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Комиссии</div>
                    <div class="checkbox-group" onclick="toggleCommissions()">
                        <input type="checkbox" id="useCommissions">
                        <label for="useCommissions">Учитывать комиссии</label>
                    </div>
                    <div class="commission-inputs" id="commissionInputs">
                        <div class="input-group">
                            <label for="exchangeFee">Комиссия биржи %</label>
                            <input type="number" id="exchangeFee" placeholder="0.1" step="0.01" value="0">
                        </div>
                        <div class="input-group">
                            <label for="paymentFee">Комиссия платежки %</label>
                            <input type="number" id="paymentFee" placeholder="0" step="0.01" value="0">
                        </div>
                    </div>
                </div>

                <div id="result"></div>
            </div>

            <div class="card" style="animation-delay:0.2s">
                <div class="card-inner-top"></div>

                <div class="section">
                    <div class="section-title">Статистика</div>
                    <div class="stats-grid">
                        <div class="stat-card" data-num="I">
                            <div class="stat-glyph">⚖</div>
                            <div class="stat-label">Всего сделок</div>
                            <div class="stat-value" id="totalTrades">0</div>
                        </div>
                        <div class="stat-card" data-num="II">
                            <div class="stat-glyph">✦</div>
                            <div class="stat-label">Общая прибыль</div>
                            <div class="stat-value profit" id="totalProfit">0 ₽</div>
                        </div>
                        <div class="stat-card" data-num="III">
                            <div class="stat-glyph">∞</div>
                            <div class="stat-label">Средняя доходность</div>
                            <div class="stat-value" id="avgPercent">0%</div>
                        </div>
                        <div class="stat-card" data-num="IV">
                            <div class="stat-glyph">†</div>
                            <div class="stat-label">Лучшая сделка</div>
                            <div class="stat-value profit" id="bestTrade">0 ₽</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Цель месяца</div>
                    <div class="goal-input-group">
                        <input type="number" id="goalAmount" placeholder="50 000" step="1000">
                        <button class="btn btn-secondary" onclick="setGoal()">Установить</button>
                    </div>
                    <div id="goalProgress"></div>
                </div>
            </div>
        </div>

        <!-- ─── CHART + ACHIEVEMENTS ─── -->
        <div class="grid-2">
            <div class="card" style="animation-delay:0.3s">
                <div class="card-inner-top"></div>
                <div class="section-title">Хроника прибыли</div>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>

            <div class="card" style="animation-delay:0.4s">
                <div class="card-inner-top"></div>
                <div class="section-title">Достижения</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
        </div>

        <!-- ─── P2P CODEX ─── -->
        <div class="codex-section">
            <p class="codex-title">Codex P2P</p>
            <p class="codex-subtitle">Семь заповедей арбитражника</p>
            <div class="codex-grid">
                <div class="codex-card" data-numeral="I">
                    <div class="codex-card-glyph">⚖</div>
                    <div class="codex-card-title">Точный расчёт</div>
                    <div class="codex-card-text">Мгновенное вычисление прибыли с учётом всех комиссий. Ни рубля не потеряется.</div>
                </div>
                <div class="codex-card" data-numeral="II">
                    <div class="codex-card-glyph">📜</div>
                    <div class="codex-card-title">Хроника сделок</div>
                    <div class="codex-card-text">Каждая сделка записана. История не лжёт — она помнит ваши победы и уроки.</div>
                </div>
                <div class="codex-card" data-numeral="III">
                    <div class="codex-card-glyph">🗡</div>
                    <div class="codex-card-title">Аналитика</div>
                    <div class="codex-card-text">Графики динамики. Средняя доходность. Лучшая и худшая сделка — всё как на ладони.</div>
                </div>
                <div class="codex-card" data-numeral="IV">
                    <div class="codex-card-glyph">⛤</div>
                    <div class="codex-card-title">Цели</div>
                    <div class="codex-card-text">Месячная цель с прогресс-баром. Знайте сколько сделок отделяет вас от триумфа.</div>
                </div>
                <div class="codex-card" data-numeral="V">
                    <div class="codex-card-glyph">🏺</div>
                    <div class="codex-card-title">Достижения</div>
                    <div class="codex-card-text">Ордена и титулы за рост. От первой сделки до легенды P2P — путь записан.</div>
                </div>
                <div class="codex-card" data-numeral="VI">
                    <div class="codex-card-glyph">🔒</div>
                    <div class="codex-card-title">Приватность</div>
                    <div class="codex-card-text">Все данные в вашем браузере. Никаких серверов. Никакой слежки. Полная тишина.</div>
                </div>
            </div>
        </div>

        <!-- ─── HISTORY ─── -->
        <div class="card" style="animation-delay:0.5s">
            <div class="card-inner-top"></div>
            <div class="history-header">
                <div style="display:flex;flex-direction:column;gap:8px;flex:1;">
                    <div class="section-title" style="margin:0">Архив сделок</div>
                    <div class="sync-note" id="syncNote">
                        <span class="sync-dot" id="syncDot"></span>
                        <span id="syncText">Хранится локально</span>
                        <button class="save-lock-link" id="syncUpgradeBtn" onclick="openPaywall()" style="display:none">† Включить синхронизацию</button>
                    </div>
                </div>
                <div class="history-actions">
                    <button class="btn-small" onclick="shareStats()">Поделиться</button>
                    <button class="btn-small" onclick="exportToCSV()">Экспорт</button>
                    <button class="btn-small danger" onclick="clearHistory()">Очистить</button>
                </div>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <span class="empty-state-icon">𝔓</span>
                    <div class="empty-state-text">Архив пуст.<br><em>Совершите первую сделку — и она будет записана здесь.</em></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <span class="footer-symbol">𝔓𝔗𝔓</span>
            © MMXXVI · P2P Calculatio · Omnia Vincit Pecunia<br>
            <a href="https://t.me/soul_angelesss" target="_blank">@soul_angelesss</a>
        </div>

    </div>

    <script>
        // ─── DATA ───
        let transactions = JSON.parse(localStorage.getItem('p2pTransactions')) || [];
        let goal         = JSON.parse(localStorage.getItem('p2pGoal'))         || null;
        let achievements = JSON.parse(localStorage.getItem('p2pAchievements')) || {};

        const achievementsList = [
            { id:'first',    icon:'⚔', title:'Prima Causa',      desc:'Первая сделка',            check:() => transactions.length >= 1 },
            { id:'five',     icon:'🜂', title:'Quinque',           desc:'5 сделок',                 check:() => transactions.length >= 5 },
            { id:'ten',      icon:'🜁', title:'Decimus',           desc:'10 сделок',                check:() => transactions.length >= 10 },
            { id:'profit1k', icon:'⚖', title:'Mille Denarii',    desc:'1 000 ₽ прибыли',          check:() => getTotalProfit() >= 1000 },
            { id:'profit10k',icon:'👑', title:'Decem Milia',      desc:'10 000 ₽ прибыли',         check:() => getTotalProfit() >= 10000 },
            { id:'streak',   icon:'🗡', title:'Invictus',         desc:'5 побед подряд',           check:() => checkWinStreak(5) },
            { id:'daily',    icon:'🌙', title:'Septem Dies',      desc:'7 дней торговли',          check:() => checkDailyStreak() },
            { id:'percent',  icon:'✦', title:'Magnum Lucrum',    desc:'Сделка с 20%+',            check:() => transactions.some(t => t.profitPercent >= 20) },
            { id:'trader',   icon:'🏛', title:'Legenda P2P',      desc:'50 сделок',                check:() => transactions.length >= 50 }
        ];

        // ─── INPUTS ───
        ['amount','buyRate','sellRate','exchangeFee','paymentFee'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateProfit);
        });
        document.getElementById('useCommissions').addEventListener('change', calculateProfit);

        // ─── CURSOR ───
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', e => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top  = e.clientY + 'px';
        });

        // ─── ASH PARTICLES ───
        (function() {
            const cont = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const el = document.createElement('div');
                el.className = 'ash-particle';
                const size = Math.random() * 2 + 0.5;
                el.style.cssText = `
                    width:${size}px; height:${size}px;
                    left:${Math.random()*100}%;
                    animation-duration:${Math.random()*25+15}s;
                    animation-delay:${Math.random()*20}s;
                    opacity:0;
                `;
                cont.appendChild(el);
            }
        })();

        // ─── CALCULATE ───
        function calculateProfit() {
            const amount   = parseFloat(document.getElementById('amount').value)   || 0;
            const buyRate  = parseFloat(document.getElementById('buyRate').value)   || 0;
            const sellRate = parseFloat(document.getElementById('sellRate').value)  || 0;
            const currency = document.getElementById('currency').value              || 'USDT';
            const useComm  = document.getElementById('useCommissions').checked;
            const exFee    = parseFloat(document.getElementById('exchangeFee').value) || 0;
            const pmFee    = parseFloat(document.getElementById('paymentFee').value)  || 0;

            if (!amount || !buyRate || !sellRate) { document.getElementById('result').innerHTML=''; return; }

            const crypto = amount / buyRate;
            let sell = crypto * sellRate;
            let fees = 0;

            if (useComm) {
                fees = (amount*exFee/100)+(sell*exFee/100)+(amount*pmFee/100)+(sell*pmFee/100);
                sell -= (sell*exFee/100)+(sell*pmFee/100);
            }

            const profit = sell - amount - (useComm?(amount*exFee/100)+(amount*pmFee/100):0);
            const pct    = (profit/amount)*100;
            const neg    = profit < 0;

            document.getElementById('result').innerHTML = `
                <div class="result-card ${neg?'negative':''}">
                    <div class="result-sigil ${neg?'neg':''}">Чистая прибыль</div>
                    <div class="result-value ${neg?'negative':''}">
                        ${neg?'−':'+'}${Math.abs(profit).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2})} ₽
                    </div>
                    <div class="result-details">
                        <div class="detail-item">
                            <div class="detail-label">Доходность</div>
                            <div class="detail-value">${pct>=0?'+':''}${pct.toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">${currency} получено</div>
                            <div class="detail-value">${crypto.toFixed(4)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Курсовая разница</div>
                            <div class="detail-value">${(sellRate-buyRate).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Комиссии</div>
                            <div class="detail-value">${fees.toFixed(2)} ₽</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveTransaction()">† Записать в архив</button>
                </div>
            `;
        }

        function toggleCommissions() {
            const cb = document.getElementById('useCommissions');
            cb.checked = !cb.checked;
            document.getElementById('commissionInputs').classList.toggle('active', cb.checked);
            calculateProfit();
        }

        // ─── SAVE ───
        function saveTransaction() {
            const amount   = parseFloat(document.getElementById('amount').value)   || 0;
            const buyRate  = parseFloat(document.getElementById('buyRate').value)   || 0;
            const sellRate = parseFloat(document.getElementById('sellRate').value)  || 0;
            const currency = document.getElementById('currency').value              || 'USDT';
            const useComm  = document.getElementById('useCommissions').checked;
            const exFee    = parseFloat(document.getElementById('exchangeFee').value) || 0;
            const pmFee    = parseFloat(document.getElementById('paymentFee').value)  || 0;

            if (!amount||!buyRate||!sellRate) return;

            const crypto = amount/buyRate;
            let sell = crypto*sellRate;
            let fees = 0;
            if (useComm) { fees=(amount*exFee/100)+(sell*exFee/100)+(amount*pmFee/100)+(sell*pmFee/100); sell-=(sell*exFee/100)+(sell*pmFee/100); }
            const profit = sell-amount-(useComm?(amount*exFee/100)+(amount*pmFee/100):0);

            transactions.unshift({
                id:Date.now(), date:new Date().toLocaleString('ru-RU'),
                timestamp:Date.now(), amount, buyRate, sellRate, currency,
                profit, profitPercent:(profit/amount)*100, cryptoAmount:crypto, fees
            });

            localStorage.setItem('p2pTransactions', JSON.stringify(transactions));
            checkAchievements();
            updateAll();

            ['amount','buyRate','sellRate'].forEach(id => document.getElementById(id).value='');
            calculateProfit();
            showNotification('† Сделка записана в архив');
        }

        function updateAll() {
            updateHistory(); updateStats(); updateChart(); updateGoalProgress(); updateHeroStats();
        }

        // ─── HERO ───
        function updateHeroStats() {
            const n   = transactions.length;
            const p   = getTotalProfit();
            const avg = n>0?transactions.reduce((s,t)=>s+t.profitPercent,0)/n:0;
            document.getElementById('h-trades').textContent = n;
            document.getElementById('h-profit').textContent = (p>=0?'+':'')+p.toFixed(0)+'₽';
            document.getElementById('h-avg').textContent    = (avg>=0?'+':'')+avg.toFixed(1)+'%';
        }

        // ─── HISTORY ───
        function updateHistory() {
            const list = document.getElementById('historyList');
            if (!transactions.length) {
                list.innerHTML=`<div class="empty-state"><span class="empty-state-icon">𝔓</span><div class="empty-state-text">Архив пуст.<br><em>Совершите первую сделку — и она будет записана здесь.</em></div></div>`;
                return;
            }
            list.innerHTML = transactions.map(tx=>`
                <div class="history-item">
                    <div class="history-item-header">
                        <div class="history-date">${tx.date}</div>
                        <button class="history-delete" onclick="deleteTransaction(${tx.id})">×</button>
                    </div>
                    <div class="history-details">
                        <div class="history-detail"><div class="history-detail-label">Пара</div><div class="history-detail-value">${tx.currency}/RUB</div></div>
                        <div class="history-detail"><div class="history-detail-label">Сумма</div><div class="history-detail-value">${tx.amount.toLocaleString('ru-RU')} ₽</div></div>
                        <div class="history-detail"><div class="history-detail-label">Прибыль</div><div class="history-detail-value ${tx.profit>=0?'history-profit':'history-loss'}">${tx.profit>=0?'+':''}${tx.profit.toFixed(2)} ₽</div></div>
                        <div class="history-detail"><div class="history-detail-label">Доходность</div><div class="history-detail-value ${tx.profitPercent>=0?'history-profit':'history-loss'}">${tx.profitPercent>=0?'+':''}${tx.profitPercent.toFixed(2)}%</div></div>
                    </div>
                </div>
            `).join('');
        }

        // ─── STATS ───
        function updateStats() {
            const n    = transactions.length;
            const p    = getTotalProfit();
            const avg  = n>0?transactions.reduce((s,t)=>s+t.profitPercent,0)/n:0;
            const best = n>0?Math.max(...transactions.map(t=>t.profit)):0;
            document.getElementById('totalTrades').textContent = n;
            document.getElementById('totalProfit').textContent = `${p>=0?'+':''}${p.toFixed(2)} ₽`;
            document.getElementById('totalProfit').className   = `stat-value ${p>=0?'profit':'loss'}`;
            document.getElementById('avgPercent').textContent  = `${avg>=0?'+':''}${avg.toFixed(2)}%`;
            document.getElementById('bestTrade').textContent   = `+${best.toFixed(2)} ₽`;
        }

        function getTotalProfit() { return transactions.reduce((s,t)=>s+t.profit,0); }

        function deleteTransaction(id) {
            showConfirm(
                'Удалить запись?',
                'Эта сделка будет стёрта из архива.<br><em>Действие нельзя отменить.</em>',
                'Удалить',
                () => {
                    transactions = transactions.filter(t=>t.id!==id);
                    localStorage.setItem('p2pTransactions', JSON.stringify(transactions));
                    updateAll(); checkAchievements();
                }
            );
        }

        function clearHistory() {
            showConfirm(
                'Уничтожить весь архив?',
                'Все записи будут стёрты навсегда.<br><em>Это действие необратимо.</em>',
                'Уничтожить',
                () => {
                    transactions=[];
                    localStorage.setItem('p2pTransactions', JSON.stringify(transactions));
                    updateAll(); checkAchievements();
                    showNotification('† Архив очищен');
                }
            );
        }

        function exportToCSV() {
            if (!transactions.length){showNotification('Архив пуст');return;}
            const h=['Дата','Валюта','Сумма','Курс покупки','Курс продажи','Прибыль','Доходность %','Комиссии'];
            const rows=transactions.map(tx=>[tx.date,tx.currency,tx.amount,tx.buyRate,tx.sellRate,tx.profit.toFixed(2),tx.profitPercent.toFixed(2),tx.fees.toFixed(2)]);
            const csv=[h,...rows].map(r=>r.join(',')).join('\n');
            const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
            const link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download=`p2p-archive-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('Архив экспортирован');
        }

        // ─── CHART ───
        let chart=null;
        function updateChart() {
            const ctx=document.getElementById('profitChart');
            if (!ctx) return;
            const last=transactions.slice(0,10).reverse();
            const labels=last.map((_,i)=>`${transactions.length-9+i}`);
            const data=last.map(t=>t.profit);
            if (chart) chart.destroy();
            chart=new Chart(ctx,{
                type:'line',
                data:{
                    labels,
                    datasets:[{
                        label:'Прибыль ₽',
                        data,
                        borderColor:'rgba(232,224,208,0.6)',
                        backgroundColor:'rgba(232,224,208,0.03)',
                        tension:0.4, fill:true,
                        pointBackgroundColor:'rgba(232,224,208,0.8)',
                        pointBorderColor:'#0a0805',
                        pointBorderWidth:2, pointRadius:4, pointHoverRadius:7,
                        borderWidth:1.5
                    }]
                },
                options:{
                    responsive:true, maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{
                        y:{
                            grid:{color:'rgba(232,224,208,0.04)'},
                            ticks:{color:'rgba(232,224,208,0.3)',font:{family:'Cinzel',size:9},callback:v=>v+'₽'}
                        },
                        x:{
                            grid:{display:false},
                            ticks:{color:'rgba(232,224,208,0.3)',font:{family:'Cinzel',size:9}}
                        }
                    }
                }
            });
        }

        // ─── GOALS ───
        function setGoal() {
            const v=parseFloat(document.getElementById('goalAmount').value);
            if (!v||v<=0){showNotification('Введите корректную цель');return;}
            goal={amount:v,startDate:new Date().toISOString()};
            localStorage.setItem('p2pGoal',JSON.stringify(goal));
            updateGoalProgress();
            showNotification('Цель записана');
        }

        function updateGoalProgress() {
            const el=document.getElementById('goalProgress');
            if (!goal){el.innerHTML='<p style="font-family:\'IM Fell English\',serif;font-style:italic;color:var(--dim);font-size:13px;margin-top:10px;">Запишите цель — и мы отследим путь к ней.</p>';return;}
            const p=getTotalProfit();
            const pct=Math.min((p/goal.amount)*100,100);
            const rem=Math.max(goal.amount-p,0);
            const avg=transactions.length>0?p/transactions.length:0;
            const need=avg>0?Math.ceil(rem/avg):0;
            el.innerHTML=`
                <div class="progress-track">
                    <div class="progress-fill" style="width:${pct}%"></div>
                </div>
                <div class="progress-pct">${pct.toFixed(1)}% достигнуто</div>
                <div class="goal-stats">
                    <div class="goal-stat"><div class="goal-stat-label">Прогресс</div><div class="goal-stat-value">${pct.toFixed(0)}%</div></div>
                    <div class="goal-stat"><div class="goal-stat-label">Осталось</div><div class="goal-stat-value">${rem.toFixed(0)}₽</div></div>
                    <div class="goal-stat"><div class="goal-stat-label">Сделок нужно</div><div class="goal-stat-value">${need}</div></div>
                </div>
            `;
        }

        // ─── ACHIEVEMENTS ───
        function checkAchievements() {
            let any=false;
            achievementsList.forEach(a=>{
                if (!achievements[a.id]&&a.check()){
                    achievements[a.id]=true; any=true;
                    setTimeout(()=>showNotification(`† ${a.title} — достижение открыто`),400);
                }
            });
            if (any) localStorage.setItem('p2pAchievements',JSON.stringify(achievements));
            updateAchievements();
        }

        function updateAchievements() {
            document.getElementById('achievementsGrid').innerHTML=achievementsList.map(a=>{
                const u=achievements[a.id];
                return `<div class="achievement ${u?'unlocked':'locked'}">
                    ${u?'<div class="achievement-badge">✓</div>':''}
                    <span class="achievement-icon">${a.icon}</span>
                    <div class="achievement-title">${a.title}</div>
                    <div class="achievement-desc">${a.desc}</div>
                </div>`;
            }).join('');
        }

        function checkWinStreak(n){
            if (transactions.length<n) return false;
            return transactions.slice(0,n).every(t=>t.profit>0);
        }

        function checkDailyStreak(){
            if (transactions.length<7) return false;
            return new Set(transactions.map(t=>new Date(t.timestamp).getDay())).size>=7;
        }

        // ─── SHARE ───
        async function shareStats() {
            if (!transactions.length){showNotification('Архив пуст для шаринга');return;}
            const p=getTotalProfit();
            const avg=transactions.reduce((s,t)=>s+t.profitPercent,0)/transactions.length;
            const best=Math.max(...transactions.map(t=>t.profit));
            const sc=document.getElementById('shareContainer');
            sc.innerHTML=`
                <div style="width:600px;background:#0a0805;border:1px solid rgba(232,224,208,0.3);border-radius:4px;padding:48px;color:#e8e0d0;text-align:center;font-family:Georgia,serif;">
                    <div style="font-size:11px;letter-spacing:6px;opacity:0.5;margin-bottom:16px;text-transform:uppercase;">P2P Calculatio</div>
                    <div style="font-size:36px;font-weight:700;margin-bottom:32px;">Мои результаты</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                        <div style="border:1px solid rgba(232,224,208,0.15);padding:20px;"><div style="font-size:10px;opacity:0.5;margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;">Сделок</div><div style="font-size:32px;font-weight:700;">${transactions.length}</div></div>
                        <div style="border:1px solid rgba(232,224,208,0.15);padding:20px;"><div style="font-size:10px;opacity:0.5;margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;">Прибыль</div><div style="font-size:32px;font-weight:700;">+${p.toFixed(0)}₽</div></div>
                        <div style="border:1px solid rgba(232,224,208,0.15);padding:20px;"><div style="font-size:10px;opacity:0.5;margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;">Доходность</div><div style="font-size:32px;font-weight:700;">${avg.toFixed(1)}%</div></div>
                        <div style="border:1px solid rgba(232,224,208,0.15);padding:20px;"><div style="font-size:10px;opacity:0.5;margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;">Рекорд</div><div style="font-size:32px;font-weight:700;">+${best.toFixed(0)}₽</div></div>
                    </div>
                    <div style="margin-top:28px;font-size:10px;opacity:0.3;letter-spacing:3px;text-transform:uppercase;">@soul_angelesss · MMXXVI</div>
                </div>
            `;
            try {
                const canvas=await html2canvas(sc.firstElementChild);
                canvas.toBlob(blob=>{
                    const url=URL.createObjectURL(blob);
                    const link=document.createElement('a');
                    link.href=url; link.download=`p2p-${new Date().toISOString().split('T')[0]}.png`;
                    link.click(); URL.revokeObjectURL(url); sc.innerHTML='';
                    showNotification('Карточка сохранена');
                });
            } catch { sc.innerHTML=''; showNotification('Ошибка создания карточки'); }
        }

        // ─── NOTIFICATION ───
        function showNotification(msg) {
            const el=document.getElementById('notification');
            el.textContent=msg; el.classList.add('show');
            clearTimeout(el._t);
            el._t=setTimeout(()=>el.classList.remove('show'),3200);
        }

        // ─── INIT ───
        updateAll();
        checkAchievements();

        // ══════════════════════════════════════════
        //  AUTH & FREEMIUM SYSTEM
        // ══════════════════════════════════════════
        let currentUser = JSON.parse(localStorage.getItem('p2pCurrentUser')) || null;
        updateAuthUI();

        // ── Helpers ──
        function isPremium() {
            return currentUser && currentUser.premium === true;
        }

        function isLoggedIn() {
            return currentUser !== null;
        }

        // ── Auth modal ──
        function openModal() {
            document.getElementById('modalBackdrop').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modalBackdrop').classList.remove('open');
            document.body.style.overflow = '';
            clearErrors();
        }

        function handleBackdropClick(e) {
            if (e.target === document.getElementById('modalBackdrop') ||
                e.target === document.querySelector('.modal-fog')) closeModal();
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModal();
                closePaywall();
                confirmCancel();
            }
        });

        function switchTab(tab) {
            const isReg = tab === 'reg';
            document.getElementById('tabReg').classList.toggle('active', isReg);
            document.getElementById('tabLogin').classList.toggle('active', !isReg);
            document.getElementById('formReg').classList.toggle('active', isReg);
            document.getElementById('formLogin').classList.toggle('active', !isReg);
            document.getElementById('modalTitle').textContent = isReg ? 'Вступить в Орден' : 'Открыть врата';
            document.getElementById('modalSubtitle').innerHTML = isReg
                ? 'Запишите своё имя в анналы P2P.<br><em>Omnia Vincit Pecunia.</em>'
                : 'Добро пожаловать обратно, арбитражник.<br><em>Fac Fortia et Patere.</em>';
            clearErrors();
        }

        function clearErrors() {
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('show'));
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            if (msg) el.textContent = msg;
            el.classList.add('show');
        }

        // Password strength
        function checkStrength(val) {
            const fill  = document.getElementById('strengthFill');
            const label = document.getElementById('strengthLabel');
            let score = 0;
            if (val.length >= 6)  score++;
            if (val.length >= 10) score++;
            if (/[A-Z]/.test(val)) score++;
            if (/[0-9]/.test(val)) score++;
            if (/[^A-Za-z0-9]/.test(val)) score++;
            const levels = [
                { pct: 0,   color: 'rgba(232,224,208,0.08)', text: '—' },
                { pct: 20,  color: 'rgba(139,26,26,0.8)',    text: 'Слабый' },
                { pct: 40,  color: 'rgba(180,130,50,0.8)',   text: 'Средний' },
                { pct: 65,  color: 'rgba(200,169,110,0.9)',  text: 'Хороший' },
                { pct: 85,  color: 'rgba(232,224,208,0.7)',  text: 'Крепкий' },
                { pct: 100, color: 'rgba(232,224,208,1)',    text: 'Надёжный' },
            ];
            const l = levels[score] || levels[0];
            fill.style.width      = l.pct + '%';
            fill.style.background = l.color;
            label.textContent     = l.text;
        }

        function submitRegister() {
            clearErrors();
            const name  = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass  = document.getElementById('regPass').value;
            const pass2 = document.getElementById('regPass2').value;
            const agree = document.getElementById('regAgree').checked;
            let ok = true;

            if (!name)                        { showError('errRegName');  ok=false; }
            if (!/\S+@\S+\.\S+/.test(email)) { showError('errRegEmail'); ok=false; }
            if (pass.length < 6)              { showError('errRegPass');  ok=false; }
            if (pass !== pass2)               { showError('errRegPass2'); ok=false; }
            if (!agree)                       { showError('errRegAgree'); ok=false; }
            if (!ok) return;

            const users = JSON.parse(localStorage.getItem('p2pUsers')) || [];
            if (users.find(u => u.email === email)) {
                showError('errRegEmail', 'Этот адрес уже записан в анналах');
                return;
            }

            const user = { name, email, pass, premium: false, joinedAt: new Date().toISOString() };
            users.push(user);
            localStorage.setItem('p2pUsers', JSON.stringify(users));

            loginUser(user);
            closeModal();
            showNotification(`† Добро пожаловать, ${name}`);
        }

        function submitLogin() {
            clearErrors();
            const email = document.getElementById('loginEmail').value.trim();
            const pass  = document.getElementById('loginPass').value;
            let ok = true;
            if (!email) { showError('errLoginEmail'); ok=false; }
            if (!pass)  { showError('errLoginPass');  ok=false; }
            if (!ok) return;

            const users = JSON.parse(localStorage.getItem('p2pUsers')) || [];
            const user  = users.find(u => u.email === email && u.pass === pass);

            if (!user) {
                showError('errLogin', '† Неверные данные — врата закрыты');
                return;
            }

            loginUser(user);
            closeModal();
            showNotification(user.premium
                ? `† Рыцарь Ордена ${user.name} возвращается`
                : `† Врата открыты. Добро пожаловать, ${user.name}`);
        }

        function loginUser(user) {
            currentUser = user;
            localStorage.setItem('p2pCurrentUser', JSON.stringify(user));
            updateAuthUI();
        }

        // ─── CUSTOM CONFIRM ───
        let _confirmCallback = null;

        function showConfirm(title, text, okLabel, cb) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').innerHTML = text;
            document.getElementById('confirmOkBtn').textContent = okLabel;
            _confirmCallback = cb;
            document.getElementById('confirmBackdrop').classList.add('open');
        }

        function confirmOk() {
            document.getElementById('confirmBackdrop').classList.remove('open');
            if (_confirmCallback) { _confirmCallback(); _confirmCallback = null; }
        }

        function confirmCancel() {
            document.getElementById('confirmBackdrop').classList.remove('open');
            _confirmCallback = null;
        }

        function logout() {
            showConfirm(
                'Покинуть Орден?',
                'Локальные данные сохранятся.<br><em>Вы можете вернуться в любой момент.</em>',
                'Выйти',
                () => {
                    currentUser = null;
                    localStorage.removeItem('p2pCurrentUser');
                    updateAuthUI();
                    showNotification('† До встречи, арбитражник');
                }
            );
        }

        function updateAuthUI() {
            const authBtn       = document.getElementById('authBtn');
            const badge         = document.getElementById('userBadge');
            const planTag       = document.getElementById('planTag');
            const upgradeBtn    = document.getElementById('upgradeBtn');
            const syncDot       = document.getElementById('syncDot');
            const syncText      = document.getElementById('syncText');
            const syncUpgradeBtn= document.getElementById('syncUpgradeBtn');

            if (currentUser) {
                authBtn.style.display = 'none';
                badge.classList.add('visible');
                document.getElementById('badgeName').textContent = currentUser.name;

                if (isPremium()) {
                    planTag.textContent = '⚜ Premium';
                    planTag.className   = 'plan-tag premium';
                    upgradeBtn.style.display = 'none';
                    document.getElementById('badgeRole').textContent = 'Рыцарь Ордена';

                    syncDot.classList.add('active');
                    syncText.textContent = 'Облачная синхронизация активна';
                    syncUpgradeBtn.style.display = 'none';
                } else {
                    planTag.textContent = 'Free';
                    planTag.className   = 'plan-tag';
                    upgradeBtn.style.display = 'inline';
                    document.getElementById('badgeRole').textContent = 'Послушник';

                    syncDot.classList.remove('active');
                    syncText.textContent = 'Хранится локально · Нет синхронизации';
                    syncUpgradeBtn.style.display = 'inline';
                }
            } else {
                authBtn.style.display = 'block';
                badge.classList.remove('visible');

                syncDot.classList.remove('active');
                syncText.textContent = 'Хранится локально · Войдите для синхронизации';
                syncUpgradeBtn.style.display = 'none';
            }
        }

        // ══════════════════════════════════════════
        //  PAYWALL
        // ══════════════════════════════════════════
        function openPaywall() {
            if (!isLoggedIn()) {
                openModal();
                showNotification('† Сначала войдите в Орден');
                return;
            }
            pwShowView('pwPlans');
            document.getElementById('paywallBackdrop').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closePaywall() {
            document.getElementById('paywallBackdrop').classList.remove('open');
            document.body.style.overflow = '';
        }

        function handlePaywallBackdrop(e) {
            if (e.target === document.getElementById('paywallBackdrop') ||
                e.target === document.querySelector('.paywall-fog')) closePaywall();
        }

        function pwShowView(id) {
            document.querySelectorAll('.pw-view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function pwGoPayment() {
            pwShowView('pwPayment');
        }

        function pwBack() {
            pwShowView('pwPlans');
        }

        // Card formatting
        function formatCard(input) {
            let v = input.value.replace(/\D/g,'').substring(0,16);
            input.value = v.replace(/(.{4})/g,'$1 ').trim();
        }

        function formatExpiry(input) {
            let v = input.value.replace(/\D/g,'').substring(0,4);
            if (v.length >= 2) v = v.substring(0,2)+'/'+v.substring(2);
            input.value = v;
        }

        function submitPayment() {
            const card   = document.getElementById('payCard').value.replace(/\s/g,'');
            const expiry = document.getElementById('payExpiry').value;
            const cvv    = document.getElementById('payCvv').value;
            const name   = document.getElementById('payName').value.trim();
            const errEl  = document.getElementById('errPay');
            errEl.classList.remove('show');

            if (card.length < 16)        { errEl.textContent='† Введите корректный номер карты'; errEl.classList.add('show'); return; }
            if (!/^\d{2}\/\d{2}$/.test(expiry)) { errEl.textContent='† Введите срок действия (ММ/ГГ)'; errEl.classList.add('show'); return; }
            if (cvv.length < 3)          { errEl.textContent='† Введите CVV (3 цифры)'; errEl.classList.add('show'); return; }
            if (!name)                   { errEl.textContent='† Введите имя держателя'; errEl.classList.add('show'); return; }

            // Simulate payment processing
            const btn = document.getElementById('paySubmitBtn');
            btn.classList.add('loading');
            btn.textContent = '† Обработка';

            setTimeout(() => {
                btn.classList.remove('loading');
                btn.textContent = '† Оплатить 99 ₽';
                activatePremium();
            }, 2200);
        }

        function activatePremium() {
            // Update user in storage
            const users = JSON.parse(localStorage.getItem('p2pUsers')) || [];
            const idx = users.findIndex(u => u.email === currentUser.email);
            if (idx !== -1) {
                users[idx].premium = true;
                localStorage.setItem('p2pUsers', JSON.stringify(users));
            }
            currentUser.premium = true;
            localStorage.setItem('p2pCurrentUser', JSON.stringify(currentUser));

            updateAuthUI();
            pwShowView('pwSuccess');

            setTimeout(() => {
                closePaywall();
                showNotification('⚜ Посвящение принято. Добро пожаловать, Рыцарь!');
            }, 3000);
        }
    </script>
</body>
</html>
